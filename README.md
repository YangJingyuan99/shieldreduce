# ShieldReduce(ATC25)

## Introduction

ShieldReduce is an outsourced storage system that improves storage efficiency via fine-grained data reduction techniques including deduplication, local and delta compression, while ensuring data confidentiality through shielded execution. This repo contains the implementation of ShieldReduce prototype.

- `./Prototype`: includes the implementation of ShieldReduce prototype.
- `./MuiltiClient`: includes the implementation of a parallelized processing of ShieldReduce prototype (dedicated to Exp#4).
- `./Result`: includes several scripts to show results and empty folders to temporarily store the results of each evaluation.
- `./Dataset`: includes scripts to get datasets used in our paper, and several empty folders to temporarily store them.
- `./ClientScrpit`: includes several sample client-side scripts that will be run to perform our experiments. 
- `./ServerScrpit`: includes several sample server-side scripts that will be run to perform our experiments.

## Publication

We will publish our paper after ATC'25.

## Dependencies

The dependencies that ShieldReduce rely on can be directly installed via `apt-get` by the following commands:

```bash
$ sudo apt-get update
$ sudo apt-get install llvm clang libboost-all-dev libleveldb-dev libjemalloc-dev liblz4-dev libssl-dev jq golang-go
```
Please ensure that the OpenSSL version is 1.1.1l or higher. If the default OpenSSL version obtained from apt-get is older than 1.1.1l, please manually install OpenSSL from this [link](https://www.openssl.org/source/).

The following SGX-related packages are required:
+ Intel® Software Guard Extensions (Intel® SGX) driver [link](https://github.com/intel/linux-sgx-driver)
+ Intel® SGX SDK [link](https://01.org/intel-software-guard-extensions/downloads)
+ Intel® Software Guard Extensions SSL [link](https://github.com/intel/intel-sgx-ssl#intel-software-guard-extensions-ssl)

The above packages can be installed from the corresponding links. In our paper, ShieldReduce is tested with Intel SGX SDK Linux 2.15 and Intel SGX SSL-1.1.1l in Ubuntu 20.04 LTS. 

Here's an SGX configuration tutorial for AliYun instance we've used as a reference that may be useful in helping you build your environment. [link](https://help.aliyun.com/zh/ecs/user-guide/build-an-sgx-encrypted-computing-environment?spm=a2c4g.11186623.help-menu-25365.d_4_1_9_2_0.3d797118MyA838#53b0d34b7cnlu)

**Note that:** according to our knowledge, ShieldReduce **does not** compile successfully in newer versions (e.g., 2.25) of the Intel SGX SDK environment. **We strongly recommend that you use the same configuration as in our experiments.**

**Build hints:**
- When executing the `ShieldReduceServer` binary, if it can not find **sgx_capable**, please copy this lib from the SGX SDK (typically in `/opt/intel/sgxsdk/lib64`).
- For psw, you need to install following psw packages: `libsgx-launch`, `libsgx-urts`, `libsgx-epid`, `libsgx-quote-ex`, `libsgx-dcap-ql`, `libsgx-dcap-ql-dev`, `libsgx-uae-service`, `libsgx-enclave-common-dev`. According to our observations, the version of psw packages does not need to be aligned with the SDK version, i.e., it is possible to directly install the latest version of psw packages. You can execute the following command for a quick installation:
```bash
# install psw
echo "deb [arch=amd64] https://download.01.org/intel-sgx/sgx_repo/ubuntu ${version_codename} main" |  tee /etc/apt/sources.list.d/intel-sgx.list
wget -qO - https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key | apt-key add -
apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y libsgx-launch libsgx-urts libsgx-epid libsgx-quote-ex libsgx-dcap-ql libsgx-dcap-ql-dev libsgx-uae-service libsgx-enclave-common-dev
systemctl enable --now aesmd.service
```
- You need to ensure that the version of SGX SSL matches the version of the SGX SDK (not necessarily need to ensure that the version of SGX SSL is the same as the version of Open SSL). For example, when you install SGX SDK v2.15, you need to install SGX SSL for [Linux 2.15.1 SGX SDK, OpenSSL 1.1.1l](https://github.com/intel/intel-sgx-ssl/releases/tag/lin_2.15.1_1.1.1l).

- When building SGX SSL, you may need build tools for building SGX SDK, please refer: [link](https://github.com/intel/linux-sgx?tab=readme-ov-file#prerequisites)

- You may need to execute the following command to enable sgx:
```bash
sudo /sbin/modprobe intel_sgx
```

# Build & Usage

## Traces

We use three real-world datasets to drive our evaluation:
(i) Linux, which includes 209 snapshots (from v2.6.11 to v6.4-rc7) of Linux source code;   
(ii) Web, which includes 78 versions (from June 13 to September 1 in 2016) of website backups of news.sina.com;  
(iii) Docker, which includes 95 versions  (from v2.1.14 to v4.1) of Docker image snapshots of Cassandra downloaded from Docker Hub.  

We also generate a synthetic dataset, namely SimOS, which is generated by applying controlled modifications to an operating system image. Specifically, we create an initial snapshot from CentOS 7 virtual disk image (originally with 1.25 GiB of data) with a total of 8 GiB space. We generate
a sequence of 30 SimOS snapshots starting from the initial image, such that each snapshot is created from the previous one by randomly picking 30% of files, modifying 30% of their contents and adding 10 MiB of new data.

Here, we introduce how to collect each trace as follows.  

- Linux

```shell
$ cd ./Dataset/linux
$ bash linux_get.sh
```

- Web (This is a non-public dataset)

- Docker

```shell
$ cd ./Dataset/docker
$ bash docker_get.sh
```

- SimOS

Download the original image, we used CentOS-7-x86_64-Azure-1704.qcow2 in our evaluation, you can also download other images and modify the script
```shell
$ cd ./Dataset/simos
$ wget https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-Azure-1704.qcow2
```

Configure the script `backup_routine.sh`
```shell
vmdir="/root/atc25ShieldReduce/Dataset/simos" # set to current dir
curdir="/root/atc25ShieldReduce/Dataset/simos" # set to current dir
a=0.3     # Percentage of files to modify
b=0.3     # Percentage of content to modify in each file
M=10000   # Target size for new files in KB for rrandomio.py
vers=30
users=1
```
**Note that:** the device used in the script may already be occupied by another device, causing the generation to fail. You can check for free devices and modify the script. By default, the script uses `/dev/loop3`.

Execute the script:
```shell
$ bash ./backup_routine.sh
```

**Note that:** in Exp#4, we also use a variant of SimOS, namely *redundant*. You can generate it by entering `./Dataset/redundant`, configuring `backup_routine.sh` like SimOS (in addition to setting `vers` to 1 and `users` to 10) and execute the script.

## Getting Started

Here are simple instructions for using the ShieldReduce system, which will help you quickly get started with the ShieldReduce system.

### ShieldReduce：Prototype

The prototype of ShieldReduce includes the client and the storage server.

#### How to Build

You need to compile the whole project with these command lines:

```shell
$ cd ./Prototype
$ bash setup.sh # for the first build
```

If the compilation succeeds, the resulting executable file can be found in the `bin` directory.

If you have trouble in build, the above **Build hints** may help you.

`config.json`: the configuration file

`Base-Containers`: the folder to store the base-container files

`Delta-Containers`: the folder to store the delta-container files

`Recipes`: the folder to store the file recipes

`ShieldReduceClient`: the ShieldReduce client

`ShieldReduceServer`: the ShieldReduce storage server

To recompile the project and clear stored data in the `bin` directory:

```shell
$ cd ./Prototype
$ bash recompile.sh # clean all store data
```

Please be aware that `recompile.sh` will copy `./Prototype/config.json` into `./Prototype/bin` for reconfiguration.

#### How to Execute

- Configuration: you can use `config.json` to configure the system.

```json
{   
    "RestoreWriter": {
        "readCacheSize_": 64 // the restore container cache size
    },
    "DataSender": {
        "storageServerIp_": "127.0.0.1", // the storage server ip (need to modify)
        "storageServerPort_": 16666, // the storage server port (need to modify)
        "clientID_": 1, // the id of the client (can be modify)
        "localSecret_": "12345", // the client master key
        "sendChunkBatchSize_": 128, // the batch size of sending chunks
        "sendRecipeBatchSize_": 1024, // the batch size of sending key recipes
        "spid_": "259A7E2BC521D75621AEA63669BEA34D", // remote attestation setting
        "quoteType_": 0, // remote attestation setting
        "iasServerType_": 0, // remote attestation setting
        "iasPrimaryKey_": "fee17e94cd834ec7a3ed4e72bf04f795", // remote attestation setting
        "iasSecKey_": "0223f86f98154b6b9316054658eda2d3", // remote attestation setting
        "iasVersion_": 4 // remote attestation setting
    }
}
```

Please ensure that you adjust `storageServerIp_` and `storageServerPort_` to match the specifications of the machines running the storage server.

- Client usage:

  Please review the command specifications:

```shell
$ cd ./ShieldReduce/Prototype/bin
$ ./ShieldReduceClient -h
./ShieldReduceClient -t [o/d] -i [inputFile path].
-t: operation ([o/d]):
        o: upload
        d: download
```

`-t`: operation type, upload/download

`-i`: input file path

Following each execution, the client will log the running result in the `client-log` located within the `bin` directory.

- Storage server usage:

  Please review the command specifications:

```shell
$ cd ./Prototype/bin
$ ./ShieldReduceServer -m 4
```

Keep in mind that you can utilize "Ctrl + C" to terminate the storage server when it is in an idle state.

#### Example

After uploading a `Docker backup`, we will upload a newer version of the `Docker backup` and complete the offline operation before downloading it as an example

Assuming that the client and the storage server are deployed on two separate machines (with the `config.json` correctly configured).

- Step 1: Launch the storage server in the storage server machine.

```shell
$ cd ./Prototype/bin
$ ./ShieldReduceServer -m 4
2025-05-09 09:43:16 <ShieldReduceServer>: In GC, cloud will merge base container
Database: using In-Memory Index.
InMemoryDatabase: cannot open the db file.
InMemoryDatabase: db file file is not exists, create a new one.
InMemoryDatabase: loaded FP index size: 0
InMemoryDatabase: sfdb_index is created
InMemoryDatabase: cannot open the sfdb file.
InMemoryDatabase: sfdb_file file is empty, create a new one.
InMemoryDatabase: loaded SF size: 0
2025-05-09 09:43:16 <SSLConnection>: init the connection to port 17777
2025-05-09 09:43:16 <ShieldReduceServer>: SGX is enable.
2025-05-09 09:43:18 <ShieldReduceServer>: create the enclave successfully.
2025-05-09 09:43:18 <OCall>: print the file name: enclave-key
2025-05-09 09:43:18 <OCall>: sealed file does not exist.
2025-05-09 09:43:18 <DataWriter>: init the DataWriter.
**Enclave**: <StorageCore>: init the StorageCore.
**Enclave**: <EnclaveBase>: init the EnclaveBase.
2025-05-09 09:43:18 <OCall>: print the file name: cm-sketch
2025-05-09 09:43:18 <OCall>: sealed file does not exist.
**Enclave**: <EcallFreqIndex>: do not need to load the index.
**Enclave**: <EcallFreqIndex>: init the EcallFreqIndex.
2025-05-09 09:43:18 <OCall>: print the file name: enclave-index-info
2025-05-09 09:43:18 <OCall>: sealed file does not exist.
2025-05-09 09:43:18 <EnclaveIndex>: init the EnclaveIndex.
2025-05-09 09:43:18 <DataReceiver>: init the DataReceiver.
2025-05-09 09:43:18 <AbsRecvDecoder>: init the AbsRecvDecoder.
**Enclave**: <EcallRecvDecoder>: init the RecvDecoder.
2025-05-09 09:43:18 <EnclaveRecvDecoder>: init the EnclaveRecvDecoder.
2025-05-09 09:43:18 <RAUtil>: init the RAUtil.
2025-05-09 09:43:18 <ServerOptThread>: init the ServerOptThread.
2025-05-09 09:43:18 <ShieldReduceServer>: waiting the request from the client.
```

- Step 2: Launch the client in the client machine to upload a backup (take Linux as example).

```shell
$ ./ShieldReduceClient -t o -i  ../../Dataset/linux/v2.6.11.tar 
2025-05-09 09:44:41 <ShieldReduceClient>: offline
2025-05-09 09:44:41 <SSLConnection>: init the connection to <172.28.114.112:17777>
2025-05-09 09:44:41 <ShieldReduceClient>: upload input file name: ../../Dataset/linux/v2.6.11.tar
2025-05-09 09:44:41 <Chunker>: using FastCDC chunking.
2025-05-09 09:44:41 <Chunker>: init the chunker.
2025-05-09 09:44:41 <DataSender>: init the DataSender.
2025-05-09 09:44:41 <DataSender>: recv the server login response well, the server is ready to process the request.
2025-05-09 09:44:41 <DataSender>: the main thread is running.
2025-05-09 09:44:43 <Chunker>: thread exit.
2025-05-09 09:44:44 <SSLConnection>: shutdown the SSL connection successfully.
2025-05-09 09:44:44 <DataSender>: thread exit.
2025-05-09 09:44:44 <ShieldReduceClient>: ../../Dataset/linux/v2.6.11.tar finish.
========Chunker Info========
total file size: 208250880
total chunk num: 24641
total thread running time: 1.844824
total MQ insert time: 1.320681
total chunking time: 0.524143
chunking time: 2.702482
============================
========DataSender Info========
total send batch num: 193
total thread running time: 2.685221
===============================
2025-05-09 09:44:44 <ShieldReduceClient>: total running time: 2.685398
```

- Step 4: Launch the client in the client machine to download the Linux backup.

```shell
$ ./ShieldReduceClient -t d -i  ../../Dataset/docker/2.1.15.tar

2023-09-20 22:51:50 <DEBEClient>: restore input file name: ../../Dataset/docker/2.1.15.tar
2023-09-20 22:51:50 <RestoreWriter>: init the RestoreWriter.
2023-09-20 22:51:50 <DataRetriever>: init the DataRetriever.
2023-09-20 22:51:50 <DataRetriever>: recv the server login response well, the server is ready to process the request.
2023-09-20 22:51:50 <DataRetriever>: total chunk num: 46490
2023-09-20 22:51:50 <DataRetriever>: file size: 366243840
2023-09-20 22:51:50 <DataRetriever>: the main thread is running.
2023-09-20 22:51:50 <RestoreWriter>: the main thread is running.
2023-09-20 22:51:50 <DataRetriever>: start to recv the data from the server.
2023-09-20 22:51:51 <SSLConnection>: shutdown the SSL connection successfully.
2023-09-20 22:51:51 <DataRetriever>: thread exit.
2023-09-20 22:51:51 <RestoreWriter>: no chunk in the message queue, all jobs are done.
2023-09-20 22:51:53 <RestoreWriter>: thread exit.
2023-09-20 22:51:53 <DEBEClient>: ../../Dataset/docker/2.1.15.tar finish.
========DataRetriever Info========
total thread running time: 0.780245
total recv chunk num: 46490
total recv data size: 366243840
==================================
========RestoreWriter Info========
total thread running time: 2.989613
write chunk num: 46490
write data size: 366243840
==================================
2023-09-20 22:51:53 <DEBEClient>: total running time: 2.990318
```

You can review the client log on the client machine in the `client-log` file

```shell
input file, opt, logical data size (B), logical chunk num, total time (s), speed (MiB/s),chunking time,totalfilesizetotal,chunkingtime
../../Dataset/docker/2.1.15.tar, upload, 374824960, 47270, 7.641989, 46.775903,0.000003,374824960.000000,1.069215
...
```

You can review the server log on the client machine in the `{log name}-log` file in `./bin`.

Take `server-log` as example:

```
BackupID, OnlineSpeed(MB/s), OnlineTime(s), AverageOnlineTime(s), BackupSize, OnlineSize, OfflineSize, OfflineTime(s), AverageOfflineTime(s), OverallReductionRatio
0, 86.445, 2.29745, 2.29745, 208250880, 100655456, 100655456, 0.00052, 0.00052, 2.06895
1, 125.682, 1.61416, 1.95581, 212725760, 132196507, 132196507, 0.000301, 0.0004105, 3.18448
2, 125.253, 1.67076, 1.86079, 219432960, 161329521, 159613353, 1.19396, 0.398261, 4.01226
3, 127.637, 1.67436, 1.81418, 224092160, 195929651, 186675253, 5.97527, 1.79251, 4.63105
...
```

Log introductions:
- `server-log`: Includes time-consuming data for backup storage;
- `sgx-log`: Includes enclave overhead;
- `restore-log`: Includes time-consuming data for backup restore;
- `indexsize-log`: Includes index overhead;
- `reduction-log`: Includes data reduction breakdown;
- `chunkinfo-log`: Contains the number of each type of chunks in the `ShieldReduceServer` backend;


- Step 5: clean up

You can use `ctrl + c` to stop the server in the server machine

#### How to Evaluate

- You can refer to the `AEInstructions.md` for detailed instructions to reproduce the experiments in our paper.
- Also, you can refer to the `SimpleExperiments.md` to reproduce the experiments easily. 

